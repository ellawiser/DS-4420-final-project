---
title: "bayes_breast_cancer"
output: html_document
date: "2025-11-27"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(brms)
```

## 1. Data loading and preprocessing
```{r}
# path to csv
bc <- read.csv("/Users/ellawiser/Desktop/DS-4420-final-project/Data/bayes_breast_cancer_clean.csv")

# quick look
head(bc)
summary(bc)
```

```{r}
# Make sure class is a factor with benign as reference
bc$class <- factor(bc$class, levels = c("B", "M"))

# Drop sample_code for modeling
bc_model <- bc |>
  select(-sample_code)

# Identify numeric predictor columns
num_cols <- colnames(bc_model)[colnames(bc_model) != "class"]

# Scale predictors
bc_model[num_cols] <- scale(bc_model[num_cols])

# Train and test split
set.seed(42)
n <- nrow(bc_model)
train_idx <- sample(1:n, size = floor(0.8 * n))

bc_train <- bc_model[train_idx, ]
bc_test  <- bc_model[-train_idx, ]

dim(bc_train)
dim(bc_test)
```

## 2. Baseline logistic regression
```{r}
glm_fit <- glm(
  class ~ .,
  data   = bc_train,
  family = binomial(link = "logit")
)

summary(glm_fit)
```

```{r}
glm_probs <- predict(glm_fit, newdata = bc_test, type = "response")
glm_pred  <- ifelse(glm_probs > 0.5, "M", "B")
glm_pred  <- factor(glm_pred, levels = levels(bc_test$class))

glm_acc <- mean(glm_pred == bc_test$class)

glm_acc
table(True = bc_test$class, Pred = glm_pred)
```
## 3. Bayesian logistic regression with `brms`
```{r}
manual_prior_bc <- c(
  set_prior("normal(0, 2)", class = "b")
)

bc_brm_logit <- brm(
  class ~ .,
  family = bernoulli("logit"),
  data   = bc_train,
  chains = 4,
  iter   = 2000,
  warmup = 500,
  prior  = manual_prior_bc
)

summary(bc_brm_logit)
```

```{r bayes-diagnostics, fig.height=4, fig.width=7}
plot(bc_brm_logit)
```

## 4. Posterior predictive probabilities and uncertainty
```{r}
# Posterior distribution of predicted probabilities on test set
post_prob <- posterior_epred(bc_brm_logit, newdata = bc_test)

dim(post_prob)  # iterations x patients

prob_mean <- colMeans(post_prob)
prob_ci   <- apply(post_prob, 2, quantile, probs = c(0.025, 0.975))

bc_test_pred <- bc_test |>
  mutate(
    prob_mean = prob_mean,
    prob_low  = prob_ci[1, ],
    prob_high = prob_ci[2, ]
  )

head(bc_test_pred[, c("class", "prob_mean", "prob_low", "prob_high")])
```

### 4.1 Uncertainty aware classification
```{r}
bc_test_pred <- bc_test_pred |>
  mutate(
    pred_class = case_when(
      prob_mean > 0.7 ~ "M",
      prob_mean < 0.3 ~ "B",
      TRUE            ~ "uncertain"
    )
  )

table(bc_test_pred$pred_class)
```

```{r}
confident <- bc_test_pred |>
  filter(pred_class != "uncertain") |>
  mutate(pred_class = factor(pred_class, levels = levels(class)))

bayes_conf_acc <- mean(confident$pred_class == confident$class)
fraction_confident <- nrow(confident) / nrow(bc_test_pred)

bayes_conf_acc
fraction_confident
table(True = confident$class, Pred = confident$pred_class)
```
### 4.2 Entropy as a scalar uncertainty score
```{r}
entropy <- function(p) {
  p <- pmin(pmax(p, 1e-6), 1 - 1e-6)
  -(p * log(p) + (1 - p) * log(1 - p))
}

bc_test_pred <- bc_test_pred |>
  mutate(entropy = entropy(prob_mean))

summary(bc_test_pred$entropy)

# Plot distribution of entropy
ggplot(bc_test_pred, aes(x = entropy)) +
  geom_histogram(bins = 30, fill = "steelblue", alpha = 0.7) +
  labs(
    title = "Predictive entropy for test patients",
    x = "Entropy",
    y = "Count"
  )
```
## 5. Visualizing posterior effects
```{r}
post_draws <- as.data.frame(bc_brm_logit)

# Example: histogram of posterior for clump_thickness
if ("b_clump_thickness" %in% names(post_draws)) {
  hist(
    post_draws$b_clump_thickness,
    main = "Posterior of coefficient for clump thickness",
    xlab = "Coefficient value"
  )
}
```

```{r conditional-effects, fig.height=4, fig.width=7}
plot(conditional_effects(bc_brm_logit, "clump_thickness"))
```

## 6. Comparison summary
```{r}
results <- tibble(
  model = c("Logistic regression", "Bayesian logistic (confident only)"),
  accuracy = c(glm_acc, bayes_conf_acc),
  fraction_of_cases_used = c(1.0, fraction_confident)
)

results
```




